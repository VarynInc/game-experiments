<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Demo: Animate sprite</title>

    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
    <script src="./flightData.js"></script>
    <script id="editable">
    "use strict";
    var canvas;
    var stage;
    var stageWidth;
    var stageHeight;
    var framerate = 30;
    var framesPerMillisecond = framerate / 1000;
    var millisecondsPerFrame = 1000 / framerate;
    var PIOneEighty = Math.PI / 180;
    var oneEightyPI = 180 / Math.PI;
    var minFlightTime = 2;
    var maxAnglePerFrame = (360 / framerate) * 2;
    var crashTimeToRemoval = 5;
    var airplaneNextId;
    var totalAirplanesSeen = 0;
    var totalAirplanesCrashed = 0;
    var activeAirplaneId = 0;
    var loader;
    var priorPoint;
    var priorMidPoint;
    var configuration = {
        flightPathAttributes: null,
        airplaneAlert: null,
        airplaneHighlight: null,
        airplaneSelected: null,
        airplaneWarning: null,
        airplaneSprites: null,
        airplaneSeedTime: null
    };
    var arrayOfAirplanes = [];
    var arrayOfLostAirplanes = [];
    var arrayOfAlertContainers = [];
    var nextAirplaneTime = -1;
    var airplaneSpriteSheet;
    var interval;
    var currentSeedIndex;
    var airplaneSpawns; // Pre-seed the current level for each airplane spawn

    function loadConfiguration() {
        configuration.flightPathAttributes = {
            lineColor: "#66ee55",
            lineWidth: 4
        };
        configuration.airplaneHighlight = {
            fillColor: "#0052fc",
            strokeColor: "#00133b",
            strokeWidth: 4
        };
        configuration.airplaneSelected = {
            fillColor: "#00ee00",
            strokeColor: "#009900",
            strokeWidth: 4
        };
        configuration.airplaneAlert = {
            fillColor: "#ee0000",
            strokeColor: "#990000",
            strokeWidth: 4
        };
        configuration.airplaneWarning = {
            fillColor: "#fcba03",
            strokeColor: "#fc1c03",
            strokeWidth: 4
        };
        configuration.airplaneSprites = [
            {
                frame: "a-jumbo",
                speed: 1.2
            },
            {
                frame: "a-jet",
                speed: 1.1
            },
            {
                frame: "a-md",
                speed: 1
            },
            {
                frame: "a-prop",
                speed: 0.75
            },
            {
                frame: "a-cub",
                speed: 0.5
            }
        ];
        configuration.chopperSprites = {
            frame: "chopper",
            speed: 0.5
        }
        configuration.militarySprites = {
            frame: "a-mil",
            speed: 1.5
        }
        configuration.airplaneSeedTime = [
            { count:  8, seedTime: 25000, max: 3, militaryCount: 0, chopperCount: 0, boss: 0 },
            { count: 10, seedTime: 12000, max: 5, militaryCount: 0, chopperCount: 0, boss: 0 },
            { count: 15, seedTime: 17000, max: 5, militaryCount: 0, chopperCount: 1, boss: 0 },
            { count: 20, seedTime: 12000, max: 5, militaryCount: 1, chopperCount: 1, boss: 1 },
            { count: 25, seedTime: 12000, max: 6, militaryCount: 1, chopperCount: 2, boss: 0 },
            { count: 30, seedTime: 12000, max: 6, militaryCount: 0, chopperCount: 0, boss: 2 },
            { count: 35, seedTime:  7500, max: 8, militaryCount: 2, chopperCount: 3, boss: 0 },
            { count: 40, seedTime:  7500, max: 8, militaryCount: 0, chopperCount: 0, boss: 3 },
            { count: 50, seedTime:  5000, max: 8, militaryCount: 3, chopperCount: 3, boss: 0 }
        ];
    };

    function init() {
        canvas = document.getElementById("myCanvas");
        loadConfiguration();

        // check to see if we are running in a browser with touch support
        stage = new createjs.Stage(canvas);
        stage.autoClear = true;
        stage.enableDOMEvents(true);
        stageWidth = stage.canvas.width;
        stageHeight = stage.canvas.height;

        createjs.Touch.enable(stage);
        createjs.Ticker.framerate = framerate;

        loadAssets();
    }

    function loadAssets() {
        loader = new createjs.LoadQueue(false);
        loader.addEventListener("complete", handleLoadComplete);
        loader.loadManifest([
            { src: "game-spritesheet.png", id: "game-sprites" },
            { src: "game-spritesheet.json", id: "game-spriteframes" },
            { src: "background.jpg", id: "background" }
        ],
        true, "./");
    }

    function getNextAirplane() {
        var nextAirplaneType = airplaneSpawns.shift();
        if (nextAirplaneType === 1) {
            return configuration.chopperSprites;
        } else if (nextAirplaneType === 2) {
            return configuration.militarySprites;
        } else {
            return configuration.airplaneSprites[nextAirplaneType - 3];
        }
    }

    function showGUI() {
        var scoreField = new createjs.Text("0", "bold 48px Arial", "#FFFFFF");
        scoreField.maxWidth = 50;
        scoreField.name = "score";
        scoreField.textAlign = "center";
        scoreField.textBaseline = "middle";
        scoreField.x = canvas.width * 0.92;
        scoreField.y = canvas.height * 0.92;
        stage.addChild(scoreField);

        var crashField = new createjs.Text("0", "bold 48px Arial", "#FFFFFF");
        crashField.maxWidth = 50;
        crashField.name = "crashes";
        crashField.textAlign = "center";
        crashField.textBaseline = "middle";
        crashField.x = canvas.width * 0.08;
        crashField.y = canvas.height * 0.92;
        stage.addChild(crashField);
    }

    function updateScore() {
        var scoreField = stage.getChildByName("score");
        if (scoreField != null) {
            scoreField.text = totalAirplanesSeen.toString();
        }
    }

    function updateCrashes() {
        var crashField = stage.getChildByName("crashes");
        if (crashField != null) {
            crashField.text = totalAirplanesCrashed.toString();
        }
    }

    function createAirplane() {
        var nextPlaneType = getNextAirplane();
        if (nextPlaneType == null) {
            console.log("Error here");
        }
        var airplaneFrame = nextPlaneType.frame;
        var airplaneSpeed = nextPlaneType.speed;
        var airplane = new createjs.Sprite(airplaneSpriteSheet, airplaneFrame);
        var longestSide = 0;
        if (airplane != null) {
            var airplaneSize = airplane.getBounds();
            airplane.width = airplaneSize.width;
            airplane.height = airplaneSize.height;
            longestSide = Math.max(airplane.width, airplane.height);
            airplane.radius = longestSide * 0.6;
            airplane.regX = airplane.width * 0.5;
            airplane.regY = airplane.height * 0.5;
            airplane.rotation = 0;
            airplane.speed = airplaneSpeed;
            airplane.updateInterval = longestSide * 0.5;
            airplane.type = airplaneFrame;
            airplane.id = airplaneNextId;
            airplane.flightData = flightData.getNextFlightNumber(airplaneFrame);
            airplane.flightData.scheduledArrival = new Date(Date.now() + (1000 * 60 * 60));
            airplane.timeoutId = 0;
            airplane.crashTimeout = crashTimeToRemoval;
            airplane.flightTime = 0;
            airplane.isCrashed = false;
            airplane.alertContainer = null;
            airplane.graphicsFillCommand = null;
            airplane.graphicsStrokeCommand = null;
            airplane.range = {
                x: -1 * airplaneSize.width,
                y: -1 * airplaneSize.height,
                width: stageWidth + airplaneSize.width,
                height: stageHeight + airplaneSize.height
            };
            airplaneNextId += 1;
            totalAirplanesSeen ++;
            arrayOfAirplanes.push(airplane);

            // Container will hold all airplane visual assets: sprite, track, highlight, effects.
            var airplaneContainer = new createjs.Container();
            airplaneContainer.x = 0;
            airplaneContainer.y = 0;
            airplaneContainer.width = stageWidth;
            airplaneContainer.height = stageHeight;

            // Shape to hold the flight path and an array to record each point on the flight path
            var drawingCanvas = new createjs.Shape();
            drawingCanvas.name = "flight-path";
            drawingCanvas.flightPath = [];
            airplane.flightPathIndex = 0;

            var graphics = new createjs.Graphics();
            var highlight = new createjs.Shape(graphics);
            graphics.setStrokeStyle(configuration.airplaneAlert.strokeWidth);
            airplane.graphicsStrokeCommand = graphics.beginStroke(configuration.airplaneAlert.strokeColor).command;
            airplane.graphicsFillCommand = graphics.beginFill(configuration.airplaneAlert.fillColor).command;
            graphics.drawCircle(0, 0, airplane.radius * 1.05);

            // define the hit area for the sprite by reusing the highlight
            var hitarea = highlight.clone(); // new createjs.Shape(hitgraphics);
            var radius = airplane.radius * 1.15; // make the hit area a little larger than the actual airplane radius
            hitarea.setTransform(0, 0, 1, 1, 0, 0, 0, -1 * airplane.regX, -1 * airplane.regY);
            airplane.hitArea = hitarea;

            highlight.x = airplane.x;
            highlight.y = airplane.y;
            highlight.alpha = 0.5;
            highlight.visible = true;
            highlight.name = "highlight";
            highlight.cache(longestSide * -1, longestSide * -1, 2 * longestSide, 2 * longestSide);

            // add DisplayObjects in drawing order
            airplaneContainer.addChild(drawingCanvas);
            airplaneContainer.addChild(highlight);
            airplaneContainer.addChild(airplane);
            stage.addChild(airplaneContainer);

            // highlight
            airplane.changeHighlightColor = function (newFillColor, newStrokeColor) {
                if (this.graphicsFillCommand != null && newFillColor) {
                    this.graphicsFillCommand.style = newFillColor;
                }
                if (this.graphicsStrokeCommand != null && newStrokeColor) {
                    this.graphicsStrokeCommand.style = newStrokeColor;
                }
                var highlight = this.parent.getChildByName("highlight");
                if (highlight != null) {
                    highlight.updateCache();
                }
            };

            airplane.setHighlight = function () {
                this.changeHighlightColor(configuration.airplaneHighlight.fillColor, configuration.airplaneHighlight.strokeColor);
            };

            airplane.setSelected = function () {
                this.changeHighlightColor(configuration.airplaneSelected.fillColor, configuration.airplaneSelected.strokeColor);
            };

            airplane.setAlert = function () {
                this.changeHighlightColor(configuration.airplaneAlert.fillColor, configuration.airplaneAlert.strokeColor);
            };

            airplane.setWarning = function () {
                this.changeHighlightColor(configuration.airplaneWarning.fillColor, configuration.airplaneWarning.strokeColor);
                // after warning clears set the prior highlight back, that that means we need to know what it was.
                // airplane.timeoutId = window.setTimeout(airplane.setHighlight.bind(airplane), 3000);
            };

            airplane.setStartPosition = function () {
                var quadrant = Math.floor(Math.random() * 4); // determines which side airplane will enter from
                var finalPosition = {};

                if (quadrant < 2) {
                    // airplane coming from either top or below
                    this.x = Math.floor(Math.random() * canvas.width);
                    finalPosition.x = Math.floor(Math.random() * canvas.width);

                    if (quadrant === 0) {
                        // airplane coming from top
                        this.y = -1 * this.height;
                        finalPosition.y = canvas.height + this.height;
                    } else {
                        // airplane coming from below
                        this.y = canvas.height + this.height;
                        finalPosition.y = -1 * this.height;
                    }
                } else {
                    // airplane coming from either right or left
                    this.y = Math.floor(Math.random() * canvas.height);
                    finalPosition.y = Math.floor(Math.random() * canvas.height);

                    if (quadrant === 2) {
                        // airplane coming from left
                        this.x = -1 * this.height;
                        finalPosition.x = canvas.width + this.height;
                    } else {
                        // airplane coming from right
                        this.x = canvas.width + this.height;
                        finalPosition.x = -1 * this.height;
                    }
                }
                this.movePlane(finalPosition);
                this.updatePosition(0, framesPerMillisecond);
            };

            airplane.setCrashed = function() {
                this.isCrashed = true;
                if (this.alertContainer != null) {
                    window.clearTimeout(this.alertTimeout);
                    this.alertTimeout = 0;
                    this.alertContainer.visible = false;
                    this.alertContainer = null;
                }
                this.crashTimeout = crashTimeToRemoval;
                this.setAlert();
            }

            // time is running time since started. DeltaTime is milliseconds since last tick.
            // Return true if we should continue updating this position.
            airplane.updatePosition = function(time, deltaTime) {
                var airplaneContainer = this.parent;
                if (this.isCrashed) {
                    this.crashTimeout -= deltaTime;
                    if (airplaneContainer != null) {
                        airplaneContainer.alpha = this.crashTimeout / crashTimeToRemoval;
                    }
                    if (this.crashTimeout <= 0) {
                        this.removeFromGame();
                    }
                    return true;
                }
                if (airplaneContainer != null) {
                    var drawingCanvas = getAirplaneFlightPathCanvas(this);
                    if (drawingCanvas != null) {
                        var flightPath = drawingCanvas.flightPath;
                        if (flightPath.length > 0) {
                            if (this.flightPathIndex >= flightPath.length) {
                                // ran out the path, clear it
                                drawingCanvas.graphics.clear();
                                drawingCanvas.flightPath = [];
                                this.flightPathIndex = 0;
                            } else {
                                // we have a flight path to trace.
                                // examine each point until we find a point in front in current direction, +/- 15 degrees
                                // if no point, flight path is bad, clear it
                                var nextPoint = null;
                                var d;
                                while (this.flightPathIndex < flightPath.length) {
                                    nextPoint = flightPath[this.flightPathIndex];
                                    d = distanceBetweenPoints(nextPoint, airplane);
                                    if (d < this.updateInterval) {
                                        // distance to next point is too small or we passed it, ignore it and get the next point
                                        this.flightPathIndex++;
                                    } else {
                                        break;
                                    }
                                }
                                if (nextPoint != null) {
                                    var deltaAngle = Math.abs(airplane.rotation - angleOfAirplane(airplane, airplane.x - nextPoint.x, airplane.y - nextPoint.y));
                                    if (deltaAngle <= maxAnglePerFrame) {
                                        this.movePlane(nextPoint);
                                    } else {
                                        // if new angle is too great then flight path is no good, clear it
                                        drawingCanvas.graphics.clear();
                                        drawingCanvas.flightPath = [];
                                        this.flightPathIndex = 0;
                                    }
                                }
                            }
                        }
                    }
                    var highlight = airplaneContainer.getChildAt(1);
                    var radians = this.rotation * PIOneEighty;
                    var timeSpeedAdjustment = this.speed * (framesPerMillisecond / deltaTime);
                    this.x += Math.sin(radians) * timeSpeedAdjustment;
                    this.y -= Math.cos(radians) * timeSpeedAdjustment;
                    highlight.x = this.x;
                    highlight.y = this.y;
                    this.flightTime += deltaTime;
                }
                return (this.flightTime < minFlightTime) || this.isVisible();
            };

            airplane.isVisible = function() {
                return this.x > this.range.x
                    && this.x < this.range.width
                    && this.y > this.range.y
                    && this.y < this.range.height;
            }

            airplane.removeFromGame = function() {
                var airplaneIndex = airplaneIndexFromId(this.id);
                if (activeAirplaneId == this.id) {
                    activeAirplaneId = 0;
                }
                if (this.timeoutId > 0) {
                    window.clearTimeout(this.timeoutId);
                    this.timeoutId = 0;
                }
                this.removeAllEventListeners();
                var airplaneContainer = this.parent;
                if (airplaneContainer != null) {
                    var highlight = airplaneContainer.getChildByName("highlight");
                    if (highlight != null) {
                        createjs.Tween.removeTweens(highlight);
                    }
                    airplaneContainer.removeAllChildren();
                    stage.removeChild(airplaneContainer);
                }
                if (airplaneIndex >= 0) {
                    arrayOfAirplanes.splice(airplaneIndex, 1);
                }
            }

            airplane.activate = function(event) {
                if (!event.primary) { return; }

                // clear the prior drawing on this airplane
                var airplane = event.target;
                if (airplane != null) {
                    if (airplane.isCrashed) {
                        return;
                    }
                    var drawingCanvas = getAirplaneFlightPathCanvas(airplane);
                    drawingCanvas.graphics.clear();
                    drawingCanvas.flightPath = [];
                    airplane.flightPathIndex = 0;

                    // Remove selected indicator from current selection.
                    if (activeAirplaneId != 0) {
                        var priorSelectedAirplane = getActiveAirplane();
                        if (priorSelectedAirplane != null) {
                            priorSelectedAirplane.setHighlight();
                        }
                    }
                    airplane.setSelected();
                    activeAirplaneId = airplane.id;

                    // register the starting point and track the mouse
                    priorPoint = new createjs.Point(stage.mouseX, stage.mouseY);
                    priorMidPoint = priorPoint.clone();
                    airplane.addEventListener("pressmove", airplane.handleMouseMove);
                    airplane.addEventListener("pressup", airplane.handleMouseUp);
                }
            }

            airplane.handleMouseMove = function(event) {
                if (!event.primary) { return; }
                var airplane = event.target;
                if (airplane != null) {
                    if (airplane.isCrashed) {
                        return;
                    }
                    var drawingCanvas = getAirplaneFlightPathCanvas(airplane);
                    if (drawingCanvas != null) {
                        var mouseX = stage.mouseX;
                        var mouseY = stage.mouseY;
                        var midPt = new createjs.Point((priorPoint.x + mouseX) / 2, (priorPoint.y + mouseY) / 2);

                        drawingCanvas.graphics
                            .setStrokeStyle(configuration.flightPathAttributes.lineWidth, 'round', 'round')
                            .beginStroke(configuration.flightPathAttributes.lineColor)
                            .moveTo(midPt.x, midPt.y)
                            .curveTo(priorPoint.x, priorPoint.y, priorMidPoint.x, priorMidPoint.y);

                        priorPoint.x = mouseX;
                        priorPoint.y = mouseY;
                        priorMidPoint.x = midPt.x;
                        priorMidPoint.y = midPt.y;
                        drawingCanvas.flightPath.push({x: mouseX, y: mouseY});
                    }
                }
            }

            airplane.handleMouseUp = function(event) {
                if (!event.primary) { return; }

                var airplane = event.target;
                if (airplane != null) {
                    // stop tracking mouse
                    airplane.removeEventListener("pressmove", airplane.handleMouseMove);
                    airplane.removeEventListener("pressup", airplane.handleMouseUp);
                }
            }

            airplane.movePlane = function (toPosition) {
                // Update rotation of airplane based on target point
                this.rotation = angleOfAirplane(this, this.x - toPosition.x, this.y - toPosition.y);
            }

            airplane.toString = function() {
                return "ID: " + this.id + " type: " + this.type + " flight time: " + this.flightTime + (this.isCrashed ? " CRASHED" : "");
            }

            airplane.addEventListener("mousedown", airplane.activate.bind(airplane));
            airplane.setHighlight();
            createjs.Tween.get(highlight, { loop: -1 })
                .to({ alpha: 0 }, 1000, createjs.Ease.getElasticIn(2, 5))
                .to({ alpha: 0.5 }, 1000, createjs.Ease.getElasticIn(2, 5));

            // position plane in its parent container
            airplane.setStartPosition();
            updateScore();
            showFlightStatus(airplane);
        }
        return airplane;
    }

    function airplaneIndexFromId(airplaneId) {
        for (var index = 0; index < arrayOfAirplanes.length; index ++) {
            if (airplaneId == arrayOfAirplanes[index].id) {
                return index;
            }
        }
        return 0;
    }

    function getActiveAirplane() {
        var activeIndex = airplaneIndexFromId(activeAirplaneId);
        if (activeIndex >= 0 && activeIndex < arrayOfAirplanes.length) {
            return arrayOfAirplanes[activeIndex];
        }
        return null;
    }

    function getAirplaneFlightPathCanvas(airplane) {
        if (airplane != null && airplane.parent != null) {
            return airplane.parent.getChildByName("flight-path");
        }
        return null;
    }

    function updateAirplanePosition(time, deltaTime) {
        arrayOfAirplanes.forEach(function(airplane) {
            if ( ! airplane.updatePosition(time, deltaTime)) {
                arrayOfLostAirplanes.push(airplane);
            }
        });
    }

    function removeLostAirplanes() {
        arrayOfLostAirplanes.forEach(function(airplane) {
            airplane.removeFromGame();
        });
        arrayOfLostAirplanes = [];
    }

    function generateSpawns() {
        // generates all airplane spawns for the current level
        var currentSeed = configuration.airplaneSeedTime[currentSeedIndex];
        var previousCount = 0; // previous count defaults to 0 for when seed = 0
        if (currentSeedIndex > 0) {
            previousCount = configuration.airplaneSeedTime[currentSeedIndex - 1].count;
        }
        var totalSpawns = currentSeed.count - previousCount; // total number of airplanes to spawn for this level
        var i;
        var nextSpawn;
        var duplicateSpawnCounter;
        airplaneSpawns = [];
        for (i = 0; i < totalSpawns; i ++) {
            airplaneSpawns[i] = 0;
        }
        if (currentSeed.chopperCount > 0) {
            for (i = 0; i < currentSeed.chopperCount; i++) {
                duplicateSpawnCounter = 10;
                do {
                    nextSpawn = Math.floor(Math.random() * totalSpawns);
                    // makes sure we haven't already assigned this spawn
                    if (airplaneSpawns[nextSpawn] === 0) {
                        airplaneSpawns[nextSpawn] = 1;
                        duplicateSpawnCounter = 0;
                    } else {
                        duplicateSpawnCounter --;
                    }
                } while (duplicateSpawnCounter > 0);
            }
        }
        if (currentSeed.militaryCount > 0) {
            for (i = 0; i < currentSeed.militaryCount; i++) {
                duplicateSpawnCounter = 10;
                do {
                    nextSpawn = Math.floor(Math.random() * totalSpawns);
                    // makes sure we haven't already assigned this spawn
                    if (airplaneSpawns[nextSpawn] === 0) {
                        airplaneSpawns[nextSpawn] = 2;
                        duplicateSpawnCounter = 0;
                    } else {
                        duplicateSpawnCounter --;
                    }
                } while (duplicateSpawnCounter > 0);
            }
        }
        for (i = 0; i < totalSpawns; i ++) {
            if (airplaneSpawns[i] === 0) {
                airplaneSpawns[i] = 3 + Math.floor(Math.random() * configuration.airplaneSprites.length);
            }
        }
        // @TODO: Remove once spawning is verified
        console.log("Generated spawns for " + currentSeedIndex + ":" + airplaneSpawns.toString());
    }

    function seedNextAirplane(currentTime, deltaTime) {
        if (arrayOfAirplanes.length < configuration.airplaneSeedTime[currentSeedIndex].max) {
            if (nextAirplaneTime == 0 || (currentTime > nextAirplaneTime)) {
                createAirplane();
                if (totalAirplanesSeen >= configuration.airplaneSeedTime[currentSeedIndex].count && currentSeedIndex < configuration.airplaneSeedTime.length-1) {
                    if (currentSeedIndex < (configuration.airplaneSeedTime.length - 1)) {
                        currentSeedIndex += 1;
                    }
                    generateSpawns();
                }
                nextAirplaneTime = currentTime + 1000 + (Math.random() * configuration.airplaneSeedTime[currentSeedIndex].seedTime);
            }
        }
    }

    function createSprites() {
        var spriteFrames = loader.getResult("game-spriteframes");
        spriteFrames.images = [loader.getResult("game-sprites")];
        spriteFrames.framerate = framerate;
        airplaneSpriteSheet = new createjs.SpriteSheet(spriteFrames);
    }

    function createBackground() {
        var background = stage.getChildByName("background");
        if (background == null) {
            background = new createjs.Shape();
            background.name = "background";
            background.graphics.beginBitmapFill(loader.getResult("background")).drawRect(0, 0, stageWidth, stageHeight);
            background.cache(0, 0, stageWidth, stageHeight);
            stage.addChild(background);
        }
    }

    function handleLoadComplete() {
        airplaneNextId = 1;
        currentSeedIndex = 0;
        airplaneSpawns = [];
        nextAirplaneTime = 0;
        createSprites();
        createBackground();
        showGUI();
        generateSpawns();
        createjs.Ticker.addEventListener("tick", onEnterFrame);
        stage.update();
    }

    function distanceBetweenPoints(pointA, pointB) {
        var xDist = pointB.x - pointA.x;
        var yDist = pointB.y - pointA.y;
        return Math.sqrt(Math.pow(xDist, 2) + Math.pow(yDist, 2));
    }

    function angleOfObject(xDist, yDist) {
        return Math.atan(yDist / xDist) * oneEightyPI;
    }

    function slopeOfLine(firstPoint, secondPoint) {
        return angleOfObject(secondPoint.x - firstPoint.x, secondPoint.y - firstPoint.y);
    }

    function angleOfAirplane(airplane, xDist, yDist) {
        var angle = angleOfObject(xDist, yDist);
        (xDist < 0) ? angle += 90 : angle -= 90;
        // adjusts to find smallest angle
        var deltaAngle = airplane.rotation - angle;
        if (deltaAngle > 180) {
            angle += 360;
        } else if (deltaAngle < -180) {
            angle -= 360;
        }
        return angle;
    }

    function collisionDetection() {
        for (var i = 0; i < arrayOfAirplanes.length - 1; i++) {
            for (var j = i + 1; j < arrayOfAirplanes.length; j++) {
                var planeA = arrayOfAirplanes[i];
                var planeB = arrayOfAirplanes[j];
                if ( ! planeA.isCrashed && ! planeB.isCrashed) {
                    var distance = distanceBetweenPoints(planeA, planeB);
                    if (distance < planeA.radius + planeB.radius) {
                        planeA.setCrashed();
                        planeB.setCrashed();
                        totalAirplanesCrashed += 2;
                        updateCrashes();
                        // returning here means no other planes will crash this frame
                        return true; // something crashed
                    }
                }
            }
        }
        return false; // no crashes
    }

    function handleMouseUp(event) {
        if (!event.primary) { return; }

        // stop tracking mouse
        stage.removeEventListener("stagemousemove", handleMouseMove);
    }

    function onEnterFrame(tickEvent) {
        var deltaTime = tickEvent.delta / 1000;
        updateAirplanePosition(tickEvent.time, deltaTime);
        removeLostAirplanes();
        collisionDetection();
        seedNextAirplane(tickEvent.time, deltaTime);
        stage.update(tickEvent);
    }

    function getFreeAlertContainer() {
        var freeAlertContainer = null;
        for (var index = 0; index < arrayOfAlertContainers.length; index ++) {
            if (arrayOfAlertContainers[index].visible == false) {
                freeAlertContainer = arrayOfAlertContainers[index];
                break;
            }
        }
        if (freeAlertContainer == null) {
            freeAlertContainer = createAlertContainer();
        }
        return freeAlertContainer;
    }

    function showNewAirplaneAlert(airplane) {
        var alertContainer = getFreeAlertContainer();
        var child;
        var airplaneFrame = airplane.currentAnimation;
        // longestSide = Math.max(airplane.width, airplane.height);
        child = alertContainer.getChildByName("sprite");
        if (child != null) {
            child.gotoAndStop(airplaneFrame);
            child.regX = airplane.width * 0.5;
            child.regY = 0;
            child.scale = 18 / airplane.height;
        }
        child = alertContainer.getChildByName("field1");
        if (child != null) {
            child.text = airplane.flightData.carrier + " " + airplane.flightData.flightNumber;
        }
        child = alertContainer.getChildByName("field2");
        if (child != null) {
            child.text = "D: " + airplane.flightData.departing;
        }
        child = alertContainer.getChildByName("field3");
        if (child != null) {
            var minutes = airplane.flightData.scheduledArrival.getMinutes();
            child.text = "A: " + airplane.flightData.scheduledArrival.getHours() + ":" + (minutes < 10 ? "0" + minutes : minutes);
        }
        alertContainer.x = airplane.x;
        if (alertContainer.x < alertContainer.width) {
            alertContainer.x = 0;
        } else if (alertContainer.x > (stageWidth - alertContainer.width)) {
            alertContainer.x = stageWidth - alertContainer.width;
        }
        alertContainer.y = airplane.y;
        if (alertContainer.y < alertContainer.height) {
            alertContainer.y = 0;
        } else if (alertContainer.y > (stageHeight - alertContainer.height)) {
            alertContainer.y = stageHeight - alertContainer.height;
        }
        alertContainer.visible = true;
        airplane.alertContainer = alertContainer;
        airplane.alertTimeout = window.setTimeout(function() {
            airplane.alertContainer = null;
            airplane.alertTimeout = 0;
            alertContainer.visible = false;
        }, 7000);
    }

    function createAlertContainer() {
        var height = 60;
        var width = 60;
        var alertContainer = new createjs.Container();
        var graphics = new createjs.Graphics();
        var background = new createjs.Shape(graphics);
        graphics.setStrokeStyle(configuration.airplaneAlert.strokeWidth);
        graphics.beginStroke(configuration.airplaneAlert.strokeColor);
        graphics.beginFill(configuration.airplaneAlert.fillColor);
        graphics.drawRoundRect(0, 0, width, height, 8);
        background.alpha = 0.5;
        alertContainer.addChild(background);
        alertContainer.width = width;
        alertContainer.height = height;

        var airplaneSprite = new createjs.Sprite(airplaneSpriteSheet);
        airplaneSprite.name = "sprite";
        airplaneSprite.x = width * 0.5;
        airplaneSprite.y = height * 0.02;
        alertContainer.addChild(airplaneSprite);

        var textField = new createjs.Text("AA 1111", "bold 10px Arial", "#FFFFFF");
        textField.maxWidth = width * 0.98;
        textField.name = "field1";
        textField.textAlign = "center";
        textField.textBaseline = "middle";
        textField.x = width * 0.5;
        textField.y = height * 0.5;
        alertContainer.addChild(textField);

        textField = new createjs.Text("D: AAA", "bold 10px Arial", "#FFFFFF");
        textField.maxWidth = width * 0.98;
        textField.name = "field2";
        textField.textAlign = "center";
        textField.textBaseline = "middle";
        textField.x = width * 0.5;
        textField.y = height * 0.68;
        alertContainer.addChild(textField);

        textField = new createjs.Text("A: 99:99", "bold 10px Arial", "#FFFFFF");
        textField.maxWidth = width * 0.98;
        textField.name = "field3";
        textField.textAlign = "center";
        textField.textBaseline = "middle";
        textField.x = width * 0.5;
        textField.y = height * 0.86;
        alertContainer.addChild(textField);

        arrayOfAlertContainers.push(alertContainer);
        stage.addChild(alertContainer);

        return alertContainer;
    }

    function showFlightStatus(airplane) {
        var statusElement = document.getElementById("statusMessage");
        if (statusElement != null) {
            statusElement.innerText = "Now entering your air space: " + airplane.flightData.carrier + " flight " + airplane.flightData.flightNumber + " departed from " + airplane.flightData.departing;
        }
        showNewAirplaneAlert(airplane);
    }
    </script>
</head>

<body onload="init();">
    <header class="EaselJS">
        <h1>Demo</h1>
        <p id="statusMessage">Click and drag to set a path for an airplane</p>
    </header>
    <canvas id="myCanvas" width="1024" height="768"></canvas>
</body>
</html>
