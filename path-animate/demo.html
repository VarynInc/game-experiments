<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Demo: Animate sprite</title>

    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
    <script id="editable">
    "use strict";
    var canvas;
    var stage;
    var stageWidth;
    var stageHeight;
    var framerate = 30;
    var framesPerMillisecond = framerate / 1000;
    var millisecondsPerFrame = 1000 / framerate;
    var PIOneEighty = Math.PI / 180;
    var oneEightyPI = 180 / Math.PI;
    var maxAirplanes = 7;
    var averageTimeToNextAirplane = 10000;
    var airplaneNextId;
    var totalAirplanesSeen = 0;
    var activeAirplaneId = 0;
    var loader;
    var priorPoint;
    var priorMidPoint;
    var flightPathAttributes;
    var airplaneAlert;
    var airplaneHighlight;
    var arrayOfAirplanes = [];
    var arrayOfLostAirplanes = [];
    var nextAirplaneTime = -1;
    var airplaneSpriteSheet;
    var interval;
    var airplaneSprites = [
        {
            frame: "a-jumbo",
            speed: 1
        },
        {
            frame: "a-jet",
            speed: 1
        },
        {
            frame: "a-md",
            speed: 1
        },
        {
            frame: "a-prop",
            speed: 0.75
        },
        {
            frame: "a-cub",
            speed: 0.5
        },
        {
            frame: "a-mil",
            speed: 1.5
        }
    ];
    var airplaneSeedTime = [
        { count: 10, seedTime: 25000, max: 3, chopper: 0, boss: 0 },
        { count: 20, seedTime: 12000, max: 5, chopper: 1, boss: 0 },
        { count: 50, seedTime:  7500, max: 8, chopper: 2, boss: 1 }
    ];

    function init() {
        canvas = document.getElementById("myCanvas");
        airplaneNextId = 1;
        flightPathAttributes = {
            lineColor: "#66ee55",
            lineWidth: 4
        };
        airplaneHighlight = {
            fillColor: "#00ee00",
            strokeColor: "#009900",
            strokeWidth: 4
        };
        airplaneAlert = {
            fillColor: "#ee0000",
            strokeColor: "#990000",
            strokeWidth: 4
        };

        //check to see if we are running in a browser with touch support
        stage = new createjs.Stage(canvas);
        stage.autoClear = true;
        stage.enableDOMEvents(true);
        stageWidth = stage.canvas.width;
        stageHeight = stage.canvas.height;

        createjs.Touch.enable(stage);
        createjs.Ticker.framerate = framerate;

        loadAssets();
    }

    function loadAssets() {
        loader = new createjs.LoadQueue(false);
        loader.addEventListener("complete", handleLoadComplete);
        loader.loadManifest([
            { src: "game-spritesheet.png", id: "game-sprites" },
            { src: "game-spritesheet.json", id: "game-spriteframes" },
            { src: "background.jpg", id: "background" }
        ],
        true, "./");
    }

    function getNextAirplane() {
        if (totalAirplanesSeen > 0 && (totalAirplanesSeen % 10 == 0)) {
            return {
                frame: "chopper",
                speed: 0.5
            }
        } else {
            return airplaneSprites[Math.floor(Math.random() * airplaneSprites.length)];
        }
    }

    function getChopperSprite() {
        return "chopper";
    }

    function showGUI() {
        var scoreField = new createjs.Text("0", "bold 48px Arial", "#FFFFFF");
        scoreField.maxWidth = 50;
        scoreField.name = "score";
        scoreField.textAlign = "center";
        scoreField.textBaseline = "middle";
        scoreField.x = canvas.width * 0.92;
        scoreField.y = canvas.height * 0.92;
        stage.addChild(scoreField);
    }

    function updateScore() {
        var scoreField = stage.getChildByName("score");
        if (scoreField != null) {
            scoreField.text = totalAirplanesSeen.toString();
        }
    }

    function createAirplane() {
        var nextPlaneType = getNextAirplane();
        var airplaneFrame = nextPlaneType.frame;
        var airplaneSpeed = nextPlaneType.speed;
        var airplane = new createjs.Sprite(airplaneSpriteSheet, airplaneFrame);
        if (airplane != null) {
            var airplaneSize = airplane.getBounds();
            airplane.width = airplaneSize.width;
            airplane.height = airplaneSize.height;
            airplane.regX = airplane.width * 0.5;
            airplane.regY = airplane.height * 0.5;
            airplane.rotation = 0;
            airplane.speed = airplaneSpeed;
            airplane.id = airplaneNextId;
            airplane.timeoutId = 0;
            airplane.range = {
                x: -1 * airplaneSize.width,
                y: -1 * airplaneSize.height,
                width: stageWidth + airplaneSize.width,
                height: stageHeight + airplaneSize.height
            };
            airplaneNextId += 1;
            totalAirplanesSeen ++;
            arrayOfAirplanes.push(airplane);

            // Container will hold all airplane visual assets: sprite, track, highlight, effects.
            var airplaneContainer = new createjs.Container();
            airplaneContainer.x = 0;
            airplaneContainer.y = 0;
            airplaneContainer.width = stageWidth;
            airplaneContainer.height = stageHeight;

            // Shape to hold the flight path and an array to record each point on the flight path
            var drawingCanvas = new createjs.Shape();
            drawingCanvas.name = "flight-path";
            drawingCanvas.flightPath = [];

            // highlight
            airplane.setHighlight = function () {
                var highlight = this.parent.getChildByName("highlight");
                if (highlight != null) {
                    var graphics = highlight.graphics;
                    graphics.clear();
                    graphics
                        .setStrokeStyle(airplaneHighlight.strokeWidth)
                        .beginStroke(airplaneHighlight.strokeColor)
                        .beginFill(airplaneHighlight.fillColor)
                        .drawCircle(0, 0, Math.max(this.width, this.height) * 0.6);
                    highlight.updateCache();
                }
            };
            airplane.setAlert = function () {
                var highlight = this.parent.getChildByName("highlight");
                if (highlight != null) {
                    var graphics = highlight.graphics;
                    graphics.clear();
                    graphics
                        .setStrokeStyle(airplaneAlert.strokeWidth)
                        .beginStroke(airplaneAlert.strokeColor)
                        .beginFill(airplaneAlert.fillColor)
                        .drawCircle(0, 0, Math.max(this.width, this.height) * 0.6);
                    highlight.updateCache();
                }
                if (this.timeoutId > 0) {
                    window.clearTimeout(this.timeoutId);
                    this.timeoutId = 0;
                }
            };

            airplane.setStartPosition = function () {
                var quadrant = Math.floor(Math.random() * 4); // determines which side airplane will enter from
                var finalPosition = {};

                if (quadrant < 2) { // airplane coming from either top or below
                    this.x = Math.floor(Math.random() * canvas.width);
                    finalPosition.x = Math.floor(Math.random() * canvas.width);

                    if (quadrant === 0) { // airplane coming from top
                        this.y = -1 * this.height;
                        finalPosition.y = canvas.height + this.height;
                    } else { // airplane coming from below
                        this.y = canvas.height + this.height;
                        finalPosition.y = -1 * this.height;
                    }
                } else { // airplane coming from either right or left
                    this.y = Math.floor(Math.random() * canvas.height);
                    finalPosition.y = Math.floor(Math.random() * canvas.height);

                    if (quadrant === 2) { // airplane coming from left
                        this.x = -1 * this.height;
                        finalPosition.x = canvas.width + this.height;
                    } else { // airplane coming from right
                        this.x = canvas.width + this.height;
                        finalPosition.x = -1 * this.height;
                    }
                }

                movePlane(this, finalPosition);

                var drawingCanvas = getAirplaneFlightPathCanvas(this);
                if (drawingCanvas != null) {
                    drawingCanvas.graphics
                        .setStrokeStyle(flightPathAttributes.lineWidth, 'round', 'round')
                        .beginStroke(flightPathAttributes.lineColor)
                        .moveTo(this.x, this.y)
                        .lineTo(finalPosition.x, finalPosition.y);
                }
            };

            // time is running time since started. DeltaTime is milliseconds since last tick.
            airplane.updatePosition = function(time, deltaTime) {
                var airplaneContainer = this.parent;
                if (airplaneContainer != null) {
                    var highlight = airplaneContainer.getChildAt(1);
                    var radians = this.rotation * PIOneEighty;
                    var timeSpeedAdjustment = this.speed * (framesPerMillisecond / deltaTime);
                    this.x += Math.sin(radians) * timeSpeedAdjustment;
                    this.y -= Math.cos(radians) * timeSpeedAdjustment;
                    highlight.x = this.x;
                    highlight.y = this.y;
                }
                return this.isVisible();
            };

            airplane.isVisible = function() {
                return this.x > this.range.x
                    && this.x < this.range.width
                    && this.y > this.range.y
                    && this.y < this.range.height;
            }

            airplane.removeFromGame = function() {
                var airplaneIndex = airplaneIndexFromId(this.id);
                if (activeAirplaneId == this.id) {
                    activeAirplaneId = 0;
                }
                if (this.timeoutId > 0) {
                    window.clearTimeout(this.timeoutId);
                    this.timeoutId = 0;
                }
                this.removeAllEventListeners();
                var airplaneContainer = this.parent;
                if (airplaneContainer != null) {
                    var highlight = airplaneContainer.getChildByName("highlight");
                    if (highlight != null) {
                        createjs.Tween.removeTweens(highlight);
                    }
                    airplaneContainer.removeAllChildren();
                    stage.removeChild(airplaneContainer);
                }
                if (airplaneIndex >= 0) {
                    arrayOfAirplanes.splice(airplaneIndex, 1);
                }
            }

            airplane.activate = function () {
                this.setHighlight();
                activeAirplaneId = this.id;
                this.timeoutId = window.setTimeout(this.setAlert.bind(this), 3000);
            };

            var graphics = new createjs.Graphics();
            var highlight = new createjs.Shape(graphics);
            highlight.x = airplane.x;
            highlight.y = airplane.y;
            highlight.alpha = 0.5;
            highlight.visible = true;
            highlight.name = "highlight";
            highlight.cache(airplane.width * -1, airplane.height * -1, 2 * airplane.width, 2 * airplane.height);

            // add DisplayObjects in drawing order
            airplaneContainer.addChild(drawingCanvas);
            airplaneContainer.addChild(highlight);
            airplaneContainer.addChild(airplane);
            stage.addChild(airplaneContainer);
            airplane.addEventListener("click", airplane.activate.bind(airplane));

            airplane.setAlert();
            createjs.Tween.get(highlight, { loop: -1 })
                .to({ alpha: 0 }, 1000, createjs.Ease.getElasticIn(2, 5))
                .to({ alpha: 0.5 }, 1000, createjs.Ease.getElasticIn(2, 5));

            // position plane in its parent container
            airplane.setStartPosition();
            updateScore();
        }
        return airplane;
    }

    function airplaneIndexFromId(airplaneId) {
        for (var index = 0; index < arrayOfAirplanes.length; index ++) {
            if (airplaneId == arrayOfAirplanes[index].id) {
                return index;
            }
        }
        return 0;
    }

    function getActiveAirplane() {
        var activeIndex = airplaneIndexFromId(activeAirplaneId);
        if (activeIndex >= 0 && activeIndex < arrayOfAirplanes.length) {
            return arrayOfAirplanes[activeIndex];
        }
        return null;
    }

    function getAirplaneFlightPathCanvas(airplane) {
        if (airplane != null && airplane.parent != null) {
            return airplane.parent.getChildByName("flight-path");
        }
        return null;
    }

    function updateAirplanePosition(time, deltaTime) {
        arrayOfAirplanes.forEach(function(airplane) {
            if ( ! airplane.updatePosition(time, deltaTime)) {
                arrayOfLostAirplanes.push(airplane);
            }
        });
    }

    function removeLostAirplanes() {
        arrayOfLostAirplanes.forEach(function(airplane) {
            airplane.removeFromGame();
        });
        arrayOfLostAirplanes = [];
    }

    function seedNextAirplane(currentTime, deltaTime) {
        if (arrayOfAirplanes.length < maxAirplanes) {
            if (nextAirplaneTime == 0 || (currentTime > nextAirplaneTime)) {
                createAirplane();
                nextAirplaneTime = currentTime + (Math.random() * averageTimeToNextAirplane);
            }
        }
    }

    function tooManyAirplanes() {
        if (arrayOfPlanes.length >= 5 && interval !== -1) {
            clearInterval(interval);
            interval = -1;
        }
        else if (interval === -1) {
            interval = setInterval(createAirplane, 5000);
        }
    }

    function createSprites() {
        var spriteFrames = loader.getResult("game-spriteframes");
        spriteFrames.images = [loader.getResult("game-sprites")];
        spriteFrames.framerate = framerate;
        airplaneSpriteSheet = new createjs.SpriteSheet(spriteFrames);
    }

    function createBackground() {
        var background = stage.getChildByName("background");
        if (background == null) {
            background = new createjs.Shape();
            background.name = "background";
            background.graphics.beginBitmapFill(loader.getResult("background")).drawRect(0, 0, stageWidth, stageHeight);
            background.cache(0, 0, stageWidth, stageHeight);
            stage.addChild(background);
        }
    }

    function handleLoadComplete() {
        createSprites();
        createBackground();
        showGUI();
        nextAirplaneTime = 0;

        stage.addEventListener("stagemousedown", handleMouseDown);
        stage.addEventListener("stagemouseup", handleMouseUp);
        createjs.Ticker.addEventListener("tick", onEnterFrame);

        stage.update();
    }

    function handleMouseDown(event) {
        if (!event.primary) { return; }

        // clear the prior drawing
        var airplane = getActiveAirplane();
        if (airplane != null) {
            var drawingCanvas = getAirplaneFlightPathCanvas(airplane);
            drawingCanvas.graphics.clear();
            drawingCanvas.flightPath = [];
        }

        // register the starting point and track the mouse
        priorPoint = new createjs.Point(stage.mouseX, stage.mouseY);
        priorMidPoint = priorPoint.clone();
        stage.addEventListener("stagemousemove", handleMouseMove);
    }

    function handleMouseMove(event) {
        if (!event.primary) { return; }
        
        var airplane = getActiveAirplane();
        if (airplane != null) {
            var drawingCanvas = getAirplaneFlightPathCanvas(airplane);
            if (drawingCanvas != null) {
                var mouseX = stage.mouseX;
                var mouseY = stage.mouseY;
                var midPt = new createjs.Point((priorPoint.x + mouseX) / 2, (priorPoint.y + mouseY) / 2);

                drawingCanvas.graphics
                    .setStrokeStyle(flightPathAttributes.lineWidth, 'round', 'round')
                    .beginStroke(flightPathAttributes.lineColor)
                    .moveTo(midPt.x, midPt.y)
                    .curveTo(priorPoint.x, priorPoint.y, priorMidPoint.x, priorMidPoint.y);

                priorPoint.x = mouseX;
                priorPoint.y = mouseY;
                drawingCanvas.flightPath.push(priorPoint);

                priorMidPoint.x = midPt.x;
                priorMidPoint.y = midPt.y;

                stage.update();
            }
        }
    }

    function distanceBetweenPoints(xDist, yDist) {

        return Math.sqrt(Math.pow(xDist, 2) + Math.pow(yDist, 2));
    }

    function angleOfObject(xDist, yDist) {

        return Math.atan(yDist/xDist) * (180 / Math.PI);
    }

<<<<<<< HEAD
    function slopeOfLine(firstPoint, secondPoint) {
        var dx = secondPoint.x - firstPoint.x;
        var dy = secondPoint.y - firstPoint.y;
        return Math.atan(dy / dx) * OneEightyPI;
    }

    function airplaneAngleToPoint(airplane, toPoint) {
        var angle = slopeOfLine(airplane, toPoint);
    }

    function angleOfAirplane(airplane, xDist, yDist) {
        var angle = angleOfObject(xDist, yDist);
        (xDist < 0) ? angle += 90 : angle -= 90;
        // adjusts to find smallest angle
        var deltaAngle = airplane.rotation - angle;
        if (deltaAngle > 180) {
            angle += 360;
        } else if (deltaAngle < -180) {
            angle -= 360;
        }
        return angle;
    }


    function movePlane(airplane, toPosition) {
        var xDist = airplane.x - toPosition.x;
        var yDist = airplane.y - toPosition.y;
        // Update angle for airplane based on target point
        airplane.rotation = angleOfAirplane(airplane, xDist, yDist);
    }

    function collisionDetection() {
        for (var i = 0; i < arrayOfPlanes.length - 1; i++) {
            for (var j = i + 1; j < arrayOfPlanes.length; j++) {
                if ((arrayOfPlanes[i].x >= arrayOfPlanes[j].x && arrayOfPlanes[i].x <= arrayOfPlanes[j].x + arrayOfPlanes[j].length) ||
                    (arrayOfPlanes[i].x + arrayOfPlanes[i].length >= arrayOfPlanes[j].x && arrayOfPlanes[i].x + arrayOfPlanes[i].length <= arrayOfPlanes[j].x)) {
                    alert("crashed");
                    if ((arrayOfPlanes[i].y >= arrayOfPlanes[j].y && arrayOfPlanes[i].y <= arrayOfPlanes[j].y + arrayOfPlanes[j].length) ||
                        (arrayOfPlanes[i].y + arrayOfPlanes[i].length >= arrayOfPlanes[j].y && arrayOfPlanes[i].y + arrayOfPlanes[i].length <= arrayOfPlanes[j].y)) {
                        alert("crashed");
                        return [i, j];
                    }
                }
            }
        }
        return [];
    }

    function handleMouseUp(event) {
        var airplane = getActiveAirplane();
        if (airplane != null) {
            movePlane(airplane, { x: stage.mouseX, y: stage.mouseY });
        }
        if (!event.primary) { return; }
        // stop tracking mouse
        stage.removeEventListener("stagemousemove", handleMouseMove);
    }

    function onEnterFrame(tickEvent) {
        var deltaTime = tickEvent.delta / 1000;
        updateAirplanePosition(tickEvent.time, deltaTime);
        removeLostAirplanes();
        seedNextAirplane(tickEvent.time, deltaTime);
        stage.update(tickEvent);
    }

    </script>
</head>

<body onload="init();">
    <header class="EaselJS">
        <h1>Demo</h1>
        <p>Draw and animate</p>
    </header>
    <canvas id="myCanvas" width="960" height="400"></canvas>
</body>
</html>